---
title: "Analysis on NFL Play-By-Play Data"
author: "Nathan Krieger, Caleb Moe"
output: github_document
---

```{r setup, include=FALSE}

library(tidyverse)

knitr::opts_chunk$set(echo = TRUE)
```

``` {r}

pbp <- readr::read_csv("https://nflsavant.com/pbp_data.php?year=2024")


```

**Introduction**

The NFL has become increasingly data-driven, and play-by-play (PBP) information provides one of the richest views into how teams behave on the field. In recent years, analysts have used PBP data to uncover trends such as fourth-down aggression, pass-rate over expectation, route combinations, motion usage, and situational efficiency.

Our project explores play-by-play trends across the NFL, focusing on how offensive decision-making and performance vary by:

Down & distance

Field position

Play type (run/pass)

Quarter & game situation

Score differential

Team tendencies

The goal is to identify meaningful behavioral patterns and performance outcomes that can help explain how modern offenses operate.

We also evaluate the robustness of our findings with multiple approaches and highlight unintuitive results requiring further investigation.


**Data**

Our analysis uses play-by-play data from NFLsavant.com, a publicly accessible resource containing detailed information for every offensive snap. The dataset includes 45 variables such as:

GameId

Quarter

Minute

YardLine

Formation

And many more...

``` {r}
# data exploration
head(pbp)
nrow(pbp)


pbp %>%
  filter(IsPass == 1) %>%
  summarize(
    n_passes = n(),
    n_ints   = sum(IsInterception == 1, na.rm = TRUE),
    int_rate = mean(IsInterception == 1, na.rm = TRUE)
  )


pbp %>%
  filter(IsPass == 1,
         YardLine >= 90, YardLine <= 99) %>%
  summarize(
    n_passes = n(),
    n_ints   = sum(IsInterception == 1, na.rm = TRUE),
    int_rate = mean(IsInterception == 1, na.rm = TRUE)
  )

#We can make PlayType a factor, I think we probably should.
#We can also make Pass Type a factor
pbp <- pbp %>%
  mutate(
    PlayType = factor(PlayType),
    PassType = factor(PassType),
    Formation = factor(Formation)
  )
levels(pbp$PlayType)
levels(pbp$PassType)
levels(pbp$Formation)



```


```{r}
#inspecting field goals to prepare to add "score" variables to the dataset
pbp %>%
  filter(PlayType == "FIELD GOAL")
  
pbp <- pbp %>%
  mutate(
    FieldGoalResult = case_when(
      # BLOCKED FG
      PlayType == "FIELD GOAL" &
        str_detect(tolower(Description), "blocked") ~ "BLOCKED",
      
      # GOOD FG (contains "good" but not "no good")
      PlayType == "FIELD GOAL" &
        str_detect(tolower(Description), "good") &
        !str_detect(tolower(Description), "no good") ~ "GOOD",
      
      # NO GOOD FG
      PlayType == "FIELD GOAL" &
        str_detect(tolower(Description), "no good") ~ "NO GOOD",
      
      # Everything else
      TRUE ~ "N/A"
    )
  )

#making FieldGoalResult a factor

pbp$FieldGoalResult <- factor(
  pbp$FieldGoalResult,
  levels = c("NO GOOD", "BLOCKED", "GOOD", "N/A")
)

#inspecting safetys
pbp %>%
  filter(str_detect(tolower(Description), "safety")) %>%
  select(GameId, Quarter, Minute, Second, OffenseTeam, DefenseTeam, Description)

pbp <- pbp %>%
  mutate(
    IsSafety = if_else(
      str_detect(tolower(Description), "safety"),
      1L,
      0L
    )
  )

#inspecting extra point
pbp %>%
  filter(PlayType == "EXTRA POINT") %>%
  select(GameId, Quarter, Minute, Second, OffenseTeam, DefenseTeam, Description)


pbp <- pbp %>%
  mutate(
    ExtraPointResult = case_when(
      # BLOCKED XP
      PlayType == "EXTRA POINT" &
        str_detect(tolower(Description), "blocked") ~ "BLOCKED",
      
      # GOOD XP
      PlayType == "EXTRA POINT" &
        str_detect(tolower(Description), "good") &
        !str_detect(tolower(Description), "no good") ~ "GOOD",
      
      # NO GOOD XP
      PlayType == "EXTRA POINT" &
        str_detect(tolower(Description), "no good") ~ "NO GOOD",
      
      # Everything else (not an XP)
      TRUE ~ "N/A"
    )
  )

#investigating blocked XP or returned 2 point conversions, there was one for PHILI Eagles vs Buccs
pbp %>%
  filter(
    str_detect(tolower(Description), "defensive two-point")
  )

#adding defensive two-points
pbp <- pbp %>%
  mutate(
    DefensiveTwoPoint = if_else(
      PlayType %in% c("EXTRA POINT", "TWO-POINT CONVERSION") &
        str_detect(tolower(Description), "two-point attempt") &
        str_detect(tolower(Description), "attempt succeeds"),
      1L,
      0L
    )
  )

#Okay now we should have data on all scoring plays

```

```{r}
#now that we have gathered all data on scoring we can try to impliment some sort of scoring function.
build_scores <- function(data) {
  
  #0) Drop old score-related columns if they exist
  data <- data %>%
    select(-any_of(c(
      "PlayIndex",
      "OffPointsPlay",
      "DefPointsPlay",
      "OffenseScore",
      "DefenseScore",
      "ScoreDiff"
    )))
  
  # 1) Compute play-level scoring + PlayIndex
  data_scored <- data %>%
    arrange(GameId, Quarter, desc(Minute), desc(Second)) %>%  # correct time order
    group_by(GameId) %>%
    mutate(
      PlayIndex = row_number(),

      # Offensive points on this play
      OffPointsPlay =
        if_else(IsTouchdown == 1 & IsInterception == 0, 6L, 0L) +
        if_else(FieldGoalResult == "GOOD", 3L, 0L) +
        if_else(ExtraPointResult == "GOOD", 1L, 0L) +
        if_else(IsTwoPointConversionSuccessful == 1 & DefensiveTwoPoint == 0, 2L, 0L),

      # Defensive points on this play
      DefPointsPlay =
        if_else(IsTouchdown == 1 & IsInterception == 1, 6L, 0L) +
        if_else(IsSafety == 1, 2L, 0L) +
        if_else(DefensiveTwoPoint == 1, 2L, 0L),
      
      OffPointsPlay = if_else(IsNoPlay == 1, 0L, OffPointsPlay),
      DefPointsPlay = if_else(IsNoPlay == 1 & IsSafety != 1, 0L, DefPointsPlay)

    ) %>%
    ungroup()
  
  # 2) Long-format team scoring table
  team_scores_long <- data_scored %>%
    select(GameId, PlayIndex, OffenseTeam, DefenseTeam, OffPointsPlay, DefPointsPlay) %>%
    
    # Offense rows
    transmute(
      GameId,
      PlayIndex,
      Team   = OffenseTeam,
      Points = OffPointsPlay
    ) %>%
    
    # Defense rows
    bind_rows(
      data_scored %>%
        select(GameId, PlayIndex, OffenseTeam, DefenseTeam, OffPointsPlay, DefPointsPlay) %>%
        transmute(
          GameId,
          PlayIndex,
          Team   = DefenseTeam,
          Points = DefPointsPlay
        )
    ) %>%
    
    arrange(GameId, PlayIndex) %>%
    group_by(GameId, Team) %>%
    mutate(TeamScore = cumsum(Points)) %>%
    ungroup()
  
  # 3) Join back to scored data
  data_joined <- data_scored %>%
    left_join(
      team_scores_long %>%
        select(GameId, PlayIndex, Team, TeamScore) %>%
        rename(OffenseTeam = Team, OffenseScore = TeamScore),
      by = c("GameId", "PlayIndex", "OffenseTeam")
    ) %>%
    left_join(
      team_scores_long %>%
        select(GameId, PlayIndex, Team, TeamScore) %>%
        rename(DefenseTeam = Team, DefenseScore = TeamScore),
      by = c("GameId", "PlayIndex", "DefenseTeam")
    )
  
  # 4) Now OffenseScore / DefenseScore exist for sure
  data_final <- data_joined %>%
    mutate(
      ScoreDiff = OffenseScore - DefenseScore
    )
  
  return(data_final)
}
pbp <- build_scores(pbp)
```

```{r}
#investigating to make sure that was right
#Example, Kansas City vs Ravens:
#KC (1), BAL (2)
#0 - 7, 7-7, 10-7, 13-7, 13-10, 20- 10, 20 - 17, 27 -17, 27- 20
pbp %>%
  filter(GameId == 2024090500) 

#Just discovered something horrible about our data... if a play is a touchdown which is later reversed due to ref decision, then the isTouchdown variable is still marked as a 1, not a 0. This is detrimental to our scoring system, I will have to try to find if there is some consistent way to get the scores corrected or if we are just doomed forever.

#looking for isTouchdown and description contains reversed
pbp %>%
  filter(
    IsTouchdown == 1,
    str_detect(tolower(Description), "reversed")
  )

#we might be ****ed: (5:00) (SHOTGUN) 9-B.YOUNG SCRAMBLES UP THE MIDDLE TO NO 1 FOR 2 YARDS (29-P.ADEBO). FUMBLES (29-P.ADEBO), RECOVERED BY CAR-15-J.MINGO AT NO 1. THE REPLAY OFFICIAL REVIEWED THE SHORT OF THE GOAL LINE RULING, AND THE PLAY WAS REVERSED. (SHOTGUN) 9-B.YOUNG SCRAMBLES UP THE MIDDLE FOR 3 YARDS, TOUCHDOWN.	

#that text displays how even when "reversed" occurs, it doesn't necessarily mean the touchdown was reversed... I have no clue what to do.

#it looks like if "TOUCHDOWN" occurs after "reversed" in the description then it is a touchdown, otherwise it is not a touchdown.


pbp <- pbp %>%
  mutate(
    desc_lower = tolower(Description),

    td_pos    = str_locate(desc_lower, "touchdown")[, 1],
    rev_pos   = str_locate(desc_lower, "reversed")[, 1],
    null_pos  = str_locate(desc_lower, "touchdown nullified")[, 1],

    CorrectIsTouchdown = case_when(
      # Explicit "TOUCHDOWN NULLIFIED ..." → always NOT a TD
      !is.na(null_pos) ~ 0L,
      
      # No "touchdown" in text at all
      is.na(td_pos) ~ 0L,

      # "touchdown" present, but no "reversed" TD stands
      !is.na(td_pos) & is.na(rev_pos) ~ 1L,

      # Both appear, and touchdown comes AFTER "reversed" TD stands
      !is.na(td_pos) & !is.na(rev_pos) & td_pos > rev_pos ~ 1L,

      # Both appear, and touchdown comes BEFORE "reversed" TD overturned
      !is.na(td_pos) & !is.na(rev_pos) & td_pos < rev_pos ~ 0L
    )
  ) %>%
  select(-desc_lower, -td_pos, -rev_pos, -null_pos)


pbp %>%
  filter(IsTouchdown != CorrectIsTouchdown) %>%
  select(GameId, Quarter, Minute, Second, OffenseTeam, DefenseTeam,
         IsTouchdown, CorrectIsTouchdown, Description)
#It looks like my "CorrectIsTouchdown" variable  can detect these "False Touchdowns" effectively
```


```{r}
#reapplying my score function except this time isTouchdown accurately describes whether or not a touchdown is a touchdown.
pbp <- pbp %>%
  mutate(
    IsTouchdown = CorrectIsTouchdown  
  )
pbp <- build_scores(pbp)

#Example, Kansas City vs Ravens:
#KC (1), BAL (2)
#0 - 7, 7-7, 10-7, 13-7, 13-10, 20- 10, 20 - 17, 27 -17, 27- 20
pbp %>%
  filter(GameId == 2024090500) 

#the final score is correct!


final_scores <- pbp %>%
  group_by(GameId) %>%
  slice_max(PlayIndex, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  transmute(
    GameId,
    Team1  = OffenseTeam,
    Score1 = OffenseScore,
    Team2  = DefenseTeam,
    Score2 = DefenseScore
  )

final_scores


#Bills vs Chiefs, one point off, why?
#0-7, 3-7, 10-7, 10-14, 10-21, 16-21, 22-21, 22-29, 29-29,29-32
pbp %>% 
  filter(GameId == 2025012601) %>%
  select(OffenseTeam, OffenseScore, DefenseTeam, DefenseScore, Description, IsNoPlay)
# we were still adding points even on noplays

#if a pick 6 happens we are adding points to offence, not defense
pbp %>% 
  filter( GameId == 2025011801) %>%
  select(OffenseTeam, OffenseScore, DefenseTeam, DefenseScore, Description, IsNoPlay, IsInterception)
#I have discovered that the wrong team is marked as offense in this game, one extra point which should be washington's is given to detroit lions because the actual data says that detroit was the offense team not washington, unfortunately this kind of error is  unavoidable unless we manually corect the data therefore, I think my time focusing on scoring is over, the scores are generally accurate or at most one scoring action off and thus can still be used mostly accurately for insights.


#
pbp %>% 
  filter( GameId == 2024090809) %>%
  select(OffenseTeam, OffenseScore, DefenseTeam, DefenseScore, Description, IsNoPlay, IsInterception)
```

``` {r}

# Pass Rate By Down

pbp %>%
  filter(Down %in% 1:4) %>%
  group_by(Down) %>%
  summarize(pass_rate = mean(IsPass == 1, na.rm = TRUE)) %>%
  ggplot(aes(x = factor(Down), y = pass_rate)) +
  geom_col() +
  labs(
    title = "Pass Rate by Down",
    x = "Down",
    y = "Pass Rate"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_minimal()


```

``` {r}

# Pass vs Run by Field Position

pbp %>%
  filter(YardLine >= 1, YardLine <= 99) %>%
  group_by(YardLine) %>%
  summarize(pass_rate = mean(IsPass == 1, na.rm = TRUE)) %>%
  ggplot(aes(YardLine, pass_rate)) +
  geom_line(size = 1.1) +
  labs(
    title = "Pass Rate by Yard Line",
    x = "Field Position (1 = Own Endzone, 99 = Opponent Goal)",
    y = "Pass Rate"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_minimal()


```

``` {r}

# Yards Gained by Down

pbp %>%
  filter(Down %in% 1:4, Yards > -20 & Yards < 100) %>%  # removes oddities
  group_by(Down) %>%
  summarize(avg_yards = mean(Yards, na.rm = TRUE)) %>%
  ggplot(aes(factor(Down), avg_yards)) +
  geom_col() +
  labs(
    title = "Average Yards Gained by Down",
    x = "Down",
    y = "Average Yards Gained"
  ) +
  theme_minimal()

```

``` {r}

# Play Type Frequency (Run, Pass, Sack)

pbp %>%
  mutate(
    play_group = case_when(
      IsPass == 1 ~ "Pass",
      IsRush == 1 ~ "Rush",
      IsSack == 1 ~ "Sack",
      TRUE ~ "Other"
    )
  ) %>%
  count(play_group) %>%
  ggplot(aes(x = reorder(play_group, n), y = n)) +
    geom_col(fill = "steelblue") +
    coord_flip() +
    labs(
      title = "Distribution of Play Types",
      x = "Play Type",
      y = "Count"
    ) +
    theme_minimal()


```

``` {r}
#Rate of big plays (20 yards or more) by down
pbp %>%
  filter(Down %in% 1:4, !is.na(Yards)) %>%
  mutate(big_play = Yards >= 20) %>%
  group_by(Down) %>%
  summarize(
    big_play_count = sum(big_play),
    total_plays = n(),
    big_play_rate = big_play_count / total_plays
  ) %>%
  ggplot(aes(x = factor(Down), y = big_play_rate)) +
  geom_col() +
  labs(
    title = "Number of Big Plays (20+ Yards) by Down",
    x = "Down",
    y = "Rate of Big Plays"
  ) +
  theme_minimal()

```

``` {r}
# Yards to go on third vs likelyhood of run or pass
pbp %>%
  filter(Down == 3, !is.na(ToGo), ToGo > 0, ToGo <= 20) %>%
  mutate(
    togo_bin = cut(
      ToGo,
      breaks = c(0, 2, 4, 6, 8, 10, 15, 20),
      include.lowest = TRUE,
      right = TRUE,
      labels = c("1–2", "3–4", "5–6", "7–8", "9–10", "11–15", "16–20")
    )
  ) %>%
  group_by(togo_bin) %>%
  summarize(
    pass_rate = mean(IsPass == 1, na.rm = TRUE),
    run_rate = mean(IsRush == 1, na.rm = TRUE),
    n_plays = n()
  ) %>%
  pivot_longer(
    cols = c(pass_rate, run_rate),
    names_to = "play_type",
    values_to = "rate"
  ) %>%
  mutate(
    play_type = recode(play_type,
      "pass_rate" = "Pass",
      "run_rate" = "Run")
  ) %>%
  ggplot(aes(x = togo_bin, y = rate, fill = play_type)) +
  geom_col(position = "dodge") +
  labs(
    title = "3rd Down Play Call by Yards to Go",
    x = "Yards to Go (Binned)",
    y = "Rate",
    fill = "Play Type"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_minimal()

```

``` {r}
# Based on field position, how likely to go for it on 4th
pbp %>%
  filter(Down == 4,
         YardLine >= 1, YardLine <= 99) %>%
  mutate(
    go_for_it = if_else(IsPass == 1 | IsRush == 1, 1L, 0L),
    yard_bin = cut(
      YardLine,
      breaks = seq(0, 100, by = 10),
      include.lowest = TRUE,
      right = TRUE,
      labels = c("1–10", "11–20", "21–30", "31–40", "41–50",
                 "51–60", "61–70", "71–80", "81–90", "91–99")
    )
  ) %>%
  group_by(yard_bin) %>%
  summarize(
    go_rate = mean(go_for_it, na.rm = TRUE),
    n_plays = n()
  ) %>%
  ggplot(aes(x = yard_bin, y = go_rate, group = 1)) +
  geom_line(size = 1.1) +
  geom_point(size = 2) +
  labs(
    title = "Go-For-It Rate on 4th Down by Field Position (Binned)",
    x = "Field Position Bin",
    y = "Go-For-It Rate"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_minimal()

```

``` {r}
#Field goal count by quarter
pbp %>%
  filter(PlayType == "FIELD GOAL") %>%
  count(Quarter) %>%
  ggplot(aes(x = factor(Quarter), y = n)) +
  geom_col() +
  labs(
    title = "Field Goals Attempted by Quarter",
    x = "Quarter",
    y = "Field Goal Attempts"
  ) +
  theme_minimal()


```

``` {r}
#likelyhood of interceptions based on down

pbp %>%
  filter(IsPass == 1, Down %in% 1:4) %>%
  group_by(Down) %>%
  summarize(
    int_rate = mean(IsInterception == 1, na.rm = TRUE),
    n_passes = n()
  ) %>%
  ggplot(aes(x = factor(Down), y = int_rate)) +
  geom_col() +
  labs(
    title = "Interception Rate by Down (Pass Plays Only)",
    x = "Down",
    y = "Interception Rate"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_minimal()


```

``` {r}

# Likelihood of interceptions based on field position 
#Some bins only have a couple interceptions at most so it might not necessarily be the most reliable data
pbp %>%
  filter(IsPass == 1,
         YardLine >= 1, YardLine <= 99) %>%
  mutate(
    yard_bin = cut(
      YardLine,
      breaks = seq(0, 100, by = 10),
      include.lowest = TRUE,
      right = TRUE,
      labels = c("1–10", "11–20", "21–30", "31–40", "41–50",
                 "51–60", "61–70", "71–80", "81–90", "91–99")
    )
  ) %>%
  group_by(yard_bin) %>%
  summarize(
    int_rate = mean(IsInterception == 1, na.rm = TRUE),
    n_passes = n()
  ) %>%
  ggplot(aes(x = yard_bin, y = int_rate, group = 1)) +
  geom_line(size = 1.1) +
  geom_point(size = 2) +
  labs(
    title = "Interception Rate by Field Position (Pass Plays Only, Binned)",
    x = "Field Position Bin",
    y = "Interception Rate"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  theme_minimal()


```

``` {r}
#Tracking "success" by using the 40%,60%,100% rule

pbp %>%
  filter(Down %in% 1:4) %>%
  mutate(
    success = case_when(
      Down == 1 ~ Yards >= 0.4 * ToGo,
      Down == 2 ~ Yards >= 0.6 * ToGo,
      Down %in% 3:4 ~ Yards >= ToGo
    )
  ) %>%
  group_by(Down) %>%
  summarize(success_rate = mean(success, na.rm = TRUE)) %>%
  ggplot(aes(factor(Down), success_rate)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(title="Success Rate by Down", x="Down", y="Success Rate")



```

``` {r}
#Pass rate by Downs and Distance (excluding plays with more than 20 yards till first down/touchdown)
pbp %>%
  filter(Down %in% 1:4, ToGo <= 20) %>%
  group_by(Down, ToGo) %>%
  summarize(pass_rate = mean(IsPass == 1), .groups="drop") %>%
  ggplot(aes(ToGo, factor(Down), fill = pass_rate)) +
  geom_tile() +
  scale_fill_viridis_c(labels = scales::percent) +
  labs(title="Pass Rate Heatmap by Down & Distance",
       x="Yards to Go", y="Down", fill="Pass Rate")


```

- A chart on team wins 


``` {r}

# Calculate wins per team from final_scores
team_wins <- final_scores %>%
  mutate(
    Winner = case_when(
      Score1 > Score2 ~ Team1,
      Score2 > Score1 ~ Team2,
      TRUE ~ "Tie"
    )
  ) %>%
  filter(Winner != "Tie") %>%
  count(Winner, name = "n_wins")

# Create the bar chart
team_wins %>%
  ggplot(aes(x = reorder(Winner, n_wins), y = n_wins)) +
  geom_col(fill = "steelblue") +
  coord_flip() +
  labs(
    title = "Total Wins by Team",
    x = "Team",
    y = "Number of Wins"
  ) +
  geom_text(aes(label = n_wins), hjust = -0.2, size = 3) +
  theme_minimal()

```

``` {r}

# Calculate Point Differential for ALL 32 Teams
all_team_differential <- final_scores %>%
  select(GameId, Team = Team1, PointsFor = Score1, PointsAgainst = Score2) %>%
  bind_rows(
    final_scores %>%
      select(GameId, Team = Team2, PointsFor = Score2, PointsAgainst = Score1)
  ) %>%
  group_by(Team) %>%
  summarize(
    PointDiff = sum(PointsFor, na.rm = TRUE) - sum(PointsAgainst, na.rm = TRUE),
    .groups = "drop"
  )

# Create the Chart
all_team_differential %>%
  ggplot(aes(x = reorder(Team, PointDiff), y = PointDiff, fill = PointDiff > 0)) +
  geom_col() +
  coord_flip() +
  scale_fill_manual(values = c("FALSE" = "#D55E00", "TRUE" = "#0072B2"), 
                    labels = c("Negative", "Positive"), 
                    name = "Differential") +
  labs(
    title = "Total Point Differential by Team",
    x = "Team",
    y = "Point Differential"
  ) +
  theme_minimal()


```


## Diving Deeper: Analyzing what makes a team successful

- Identify the Top 5 Teams and Filter Data

``` {r}

# --- 1. Calculate Point Differential ---
team_differential <- final_scores %>%
  select(GameId, Team = Team1, PointsFor = Score1, PointsAgainst = Score2) %>%
  bind_rows(
    final_scores %>%
      select(GameId, Team = Team2, PointsFor = Score2, PointsAgainst = Score1)
  ) %>%
  group_by(Team) %>%
  summarize(
    PointDiff = sum(PointsFor, na.rm = TRUE) - sum(PointsAgainst, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(PointDiff))

# --- 2. Define Top 5 and Bottom 5 Teams ---
top_teams <- team_differential %>% slice_head(n = 5) %>% pull(Team)
bottom_teams <- team_differential %>% slice_tail(n = 5) %>% pull(Team) # slice_tail gets the bottom rows

# --- 3. Create Datasets for Analysis ---

# Top 5 Data
top_games <- final_scores %>% filter(Team1 %in% top_teams | Team2 %in% top_teams)
top_5_offense <- pbp %>%
  semi_join(top_games, by = "GameId") %>%
  filter(OffenseTeam %in% top_teams)

# Bottom 5 Data
bottom_games <- final_scores %>% filter(Team1 %in% bottom_teams | Team2 %in% bottom_teams)
bottom_5_offense <- pbp %>%
  semi_join(bottom_games, by = "GameId") %>%
  filter(OffenseTeam %in% bottom_teams)

```

- Offensive Efficiency Chart

``` {r}

# Summary statistics by Team
team_stats <- top_5_offense %>%
  group_by(OffenseTeam) %>%
  summarize(
    Plays = n(),
    YPP = mean(Yards, na.rm = TRUE),
    SuccessRate = mean(Yards > 0, na.rm = TRUE),
    Explosives = sum(Yards >= 15, na.rm = TRUE),
    TDs = sum(IsTouchdown == 1, na.rm = TRUE),
    .groups = "drop"
  )

# Chart: Yards Per Play Comparison
team_stats %>%
  ggplot(aes(x = reorder(OffenseTeam, YPP), y = YPP, fill = OffenseTeam)) +
  geom_col() +
  coord_flip() +
  labs(
    title = "Offensive Efficiency: Yards Per Play",
    subtitle = "Top 5 Teams by Point Differential",
    x = "Team",
    y = "Average Yards Per Play"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

```

``` {r}

# Bottom 5 Stats
bottom_stats <- bottom_5_offense %>%
  group_by(OffenseTeam) %>%
  summarize(YPP = mean(Yards, na.rm = TRUE), .groups = "drop")

# Bottom 5 Chart
bottom_stats %>%
  ggplot(aes(x = reorder(OffenseTeam, YPP), y = YPP, fill = OffenseTeam)) +
  geom_col() + coord_flip() +
  labs(title = "Offensive Efficiency: Yards Per Play", subtitle = "Bottom 5 Teams by Point Differential",
       x = "Team", y = "Average Yards Per Play") +
  theme_minimal() + theme(legend.position = "none")

```

- Play-Calling Tendencies Chart

``` {r}

# Top 5 Tendencies
top_tendencies <- top_5_offense %>%
  group_by(OffenseTeam) %>%
  summarize(PassRate = mean(IsPass == 1, na.rm = TRUE),
            RushRate = mean(IsRush == 1, na.rm = TRUE), .groups = "drop") %>%
  pivot_longer(cols = c(PassRate, RushRate), names_to = "Type", values_to = "Rate")

# Top 5 Chart
top_tendencies %>%
  ggplot(aes(x = OffenseTeam, y = Rate, fill = Type)) +
  geom_col(position = "fill") + scale_y_continuous(labels = scales::percent) +
  labs(title = "Play-Calling Tendencies", subtitle = "Top 5 Teams",
       x = "Team", y = "Percentage", fill = "Type") +
  theme_minimal()

```
``` {r}

# Bottom 5 Tendencies
bottom_tendencies <- bottom_5_offense %>%
  group_by(OffenseTeam) %>%
  summarize(PassRate = mean(IsPass == 1, na.rm = TRUE),
            RushRate = mean(IsRush == 1, na.rm = TRUE), .groups = "drop") %>%
  pivot_longer(cols = c(PassRate, RushRate), names_to = "Type", values_to = "Rate")

# Bottom 5 Chart
bottom_tendencies %>%
  ggplot(aes(x = OffenseTeam, y = Rate, fill = Type)) +
  geom_col(position = "fill") + scale_y_continuous(labels = scales::percent) +
  labs(title = "Play-Calling Tendencies", subtitle = "Bottom 5 Teams",
       x = "Team", y = "Percentage", fill = "Type") +
  theme_minimal()

```

- Down Efficiency Chart

``` {r}

# Top 5 Down Stats
top_down_stats <- top_5_offense %>%
  filter(Down == 3) %>%
  group_by(OffenseTeam) %>%
  summarize(SuccessRate = mean(Yards > 0, na.rm = TRUE), .groups = "drop")

# Top 5 Chart
top_down_stats %>%
  ggplot(aes(x = reorder(OffenseTeam, SuccessRate), y = SuccessRate, fill = OffenseTeam)) +
  geom_col() + scale_y_continuous(labels = scales::percent) +
  labs(title = "3rd Down Success Rate", subtitle = "Top 5 Teams",
       x = "Team", y = "Success Rate") +
  theme_minimal() + theme(legend.position = "none")
```

``` {r}

# Bottom 5 Down Stats
bottom_down_stats <- bottom_5_offense %>%
  filter(Down == 3) %>%
  group_by(OffenseTeam) %>%
  summarize(SuccessRate = mean(Yards > 0, na.rm = TRUE), .groups = "drop")

# Bottom 5 Chart
bottom_down_stats %>%
  ggplot(aes(x = reorder(OffenseTeam, SuccessRate), y = SuccessRate, fill = OffenseTeam)) +
  geom_col() + scale_y_continuous(labels = scales::percent) +
  labs(title = "3rd Down Success Rate", subtitle = "Bottom 5 Teams",
       x = "Team", y = "Success Rate") +
  theme_minimal() + theme(legend.position = "none")

```

- Field Position Chart

``` {r}

# Top 5 Field Pos
top_field <- top_5_offense %>%
  group_by(OffenseTeam) %>%
  summarize(AvgStart = mean(YardLine, na.rm = TRUE), .groups = "drop")

# Top 5 Chart
top_field %>%
  ggplot(aes(x = reorder(OffenseTeam, AvgStart), y = AvgStart)) +
  geom_point(size = 4, color = "darkblue") +
  geom_segment(aes(x = OffenseTeam, xend = OffenseTeam, y = 0, yend = AvgStart), color = "darkblue") +
  coord_flip() +
  labs(title = "Average Starting Field Position", subtitle = "Top 5 Teams",
       x = "Team", y = "Yard Line") +
  theme_minimal()

```

``` {r}

# Bottom 5 Field Pos
bottom_field <- bottom_5_offense %>%
  group_by(OffenseTeam) %>%
  summarize(AvgStart = mean(YardLine, na.rm = TRUE), .groups = "drop")

# Bottom 5 Chart
bottom_field %>%
  ggplot(aes(x = reorder(OffenseTeam, AvgStart), y = AvgStart)) +
  geom_point(size = 4, color = "firebrick") +
  geom_segment(aes(x = OffenseTeam, xend = OffenseTeam, y = 0, yend = AvgStart), color = "firebrick") +
  coord_flip() +
  labs(title = "Average Starting Field Position", subtitle = "Bottom 5 Teams",
       x = "Team", y = "Yard Line") +
  theme_minimal()
```

